<!DOCTYPE html>




<html class="theme-next mist" lang="default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="asp.net core," />










<meta name="description" content="这是一份收集了所有从官方文档看到的并且需要引起特别注意的内容，将持续不间断更新">
<meta name="keywords" content="asp.net core">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET Core 注意事项汇总">
<meta property="og:url" content="https://berdypango.github.io/Web/ASP-NET-Core/aspnetcore-notes/index.html">
<meta property="og:site_name" content="FrostHe.Handbook">
<meta property="og:description" content="这是一份收集了所有从官方文档看到的并且需要引起特别注意的内容，将持续不间断更新">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-09-14T01:48:17.382Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ASP.NET Core 注意事项汇总">
<meta name="twitter:description" content="这是一份收集了所有从官方文档看到的并且需要引起特别注意的内容，将持续不间断更新">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"display":"hide"},
    fancybox: true,
    tabs: true,
    motion: {"enable":false},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://berdypango.github.io/Web/ASP-NET-Core/aspnetcore-notes/"/>





  <title>ASP.NET Core 注意事项汇总 | FrostHe.Handbook</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  

  <div class="container  page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">FrostHe.Handbook</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://berdypango.github.io/Web/ASP-NET-Core/aspnetcore-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frost He">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FrostHe.Handbook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ASP.NET Core 注意事项汇总</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-31T09:26:45+08:00">
                2017-07-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/" itemprop="url" rel="index">
                    <span itemprop="name">Web</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/ASP-NET-Core/" itemprop="url" rel="index">
                    <span itemprop="name">ASP.NET Core</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  1,476
                </span>
              

              

              
            </div>
          

          
              <div class="post-description">
                  这是一份收集了所有从官方文档看到的并且需要引起特别注意的内容，将持续不间断更新
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="DI-中的-AddScope-何时使用"><a href="#DI-中的-AddScope-何时使用" class="headerlink" title="DI 中的 AddScope 何时使用?"></a>DI 中的 AddScope 何时使用?</h2><ul>
<li>基于 <code>Scoped</code> 作用域生存期服务将与每个请求的生命周期一致，即一个 <code>HttpContext</code> 一个实例。</li>
<li>因为中间件在程序 Startup 时构造，而非 per-request，如果<strong>中间件</strong>需要使用注册为 <code>Scope</code> 的服务，请将该服务注入至 <code>Invoke</code> 或 <code>InvokeAsync</code> 方法，而不要通过构造函数进行注入，因为它会<strong>强制服务的行为与单一实例类似。</strong>微软官方的提示为:</li>
</ul>
<blockquote>
<p>Because middleware is constructed at app startup, not per-request, scoped lifetime services used by middleware constructors aren’t shared with other dependency-injected types during each request. If you must share a scoped service between your middleware and other types, add these services to the Invoke method’s signature. The Invoke method can accept additional parameters that are populated by DI — <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-2.1" target="_blank" rel="noopener">MSDN-Middleware</a></p>
</blockquote>
<h2 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h2><ul>
<li><code>Policy</code>: 可基于一个或多个 Requirement 定义的授权策略，以 Name 进行区分</li>
<li><code>Requirement</code>: 定义授权的要求</li>
<li><code>Handler</code>: 定义如何处理授权 Requirement</li>
</ul>
<h3 id="基于角色的授权机制"><a href="#基于角色的授权机制" class="headerlink" title="基于角色的授权机制"></a>基于角色的授权机制</h3><ul>
<li>在 <code>Role-Based</code> 授权机制中，如果对某个 <code>Controller</code> 或 <code>Action</code> 应用了两个 <code>[Authorize(Roles = &quot;XXX&quot;)]</code>，表示访问者角色必须同时满足两者才授权访问，而如果只应用一个 <code>[Authorize(Roles = &quot;A, B&quot;)]</code> 则表示访问者角色是 A 或 B 即授权访问。</li>
<li>如果使用基于 Policy 的 Role-Based 授权机制，那么在 <code>Startup</code> 的 <code>ConfigureServices</code> 方法中，指定多个值以允许任一满足条件的访问者角色。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options.AddPolicy(<span class="string">"ElevatedRights"</span>, policy =&gt; policy.RequireRole(<span class="string">"Administrator"</span>, <span class="string">"PowerUser"</span>, <span class="string">"BackupAdministrator"</span>));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="基于-Claim-的授权机制"><a href="#基于-Claim-的授权机制" class="headerlink" title="基于 Claim 的授权机制"></a>基于 Claim 的授权机制</h3><ul>
<li>Claim 授权与 Policy 一起工作，Claim 通常以名值对的形式出现</li>
<li>Claim 声明主体是什么，而非主体能够做什么</li>
<li>如果在 Controller 或 Method 上应用多个授权特性，那么访问者必须满足所有 Policy 才会授权，例如:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Authorize(Policy = &quot;EmployeeOnly&quot;)]</span><br><span class="line">public class SalaryController : Controller</span><br><span class="line">&#123;</span><br><span class="line">    public ActionResult Payslip()</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [Authorize(Policy = &quot;HumanResources&quot;)]</span><br><span class="line">    public ActionResult UpdateSalary()</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="您真的了解中间件吗"><a href="#您真的了解中间件吗" class="headerlink" title="您真的了解中间件吗?"></a>您真的了解中间件吗?</h2><ul>
<li>IApplicationBuilder 提供了 <code>Map</code> 和 <code>MapWhen</code> 方法以对入站的 <code>Request</code> 进行分支处理，例如 <code>app.Map(&quot;/map1&quot;, builder =&gt; builder.Use&lt;TestMiddleware&gt;())</code> 将匹配以 <code>/map1</code> 开头的请求应用 <code>TestMiddleware</code>。</li>
</ul>
<h3 id="隐式激活中间件还是基于工厂的方式激活中间件"><a href="#隐式激活中间件还是基于工厂的方式激活中间件" class="headerlink" title="隐式激活中间件还是基于工厂的方式激活中间件?"></a>隐式激活中间件还是基于工厂的方式激活中间件?</h3><p>默认情况下，任何以 <code>Middleware</code> 命名结尾隐式地将该类型声明为一个中间件，不用实现任何接口，但该类型中的必须包含一个 <code>public async Task InvokeAsync(HttpContext context)</code> 方法。在调用 <code>IApplicationBuilder.UseMiddleware</code> 方法时可传入该类型。以这种方式激活的中间件与应用程序生命周期一致，且在依赖 per-request 的 <code>Scope</code> 服务时需要注意，不能将依赖声明在构造函数中，而应声明在 <code>InvokeAsync</code> 方法的参数表中，见上文。</p>
<p>然而，ASP.NET Core 提供了一个 <code>IMiddleware</code> 接口，并且该接口定义了 <code>public async Task InvokeAsync(HttpContext context)</code> 方法，实现了该接口的中间件类型将由 <code>IMiddlewareFactory</code> 创建，这意味着:</p>
<ul>
<li>该中间件支持以 <code>per-request</code> 和 <code>Transient</code> 作用域注册为服务。可在中间件的构造函数中注入 <code>Scoped</code> 或 <code>Transient</code> 作用域的服务实例。</li>
<li>强类型化</li>
<li>需要在 <code>Startp.Configure</code> 方法中对该中间件类型进行注册，例如: <code>services.AddTransient&lt;FactoryActivatedMiddleware&gt;()</code></li>
<li>调用 <code>IApplicationBuilder.UseMiddleware</code> 方法时无法再传入 <code>Options</code> 参数，将会抛出 <code>NotSupportedException</code> 异常</li>
</ul>
<p><code>IMiddlewareFactory</code> 的默认实现 <code>MiddlewareFactory</code> 以 <code>Scoped</code> 作用域注册到 DI 中，该类型位于 <code>Microsoft.AspNetCore.Http</code>。</p>
<h2 id="为何会有-Filters-Attribute"><a href="#为何会有-Filters-Attribute" class="headerlink" title="为何会有 Filters Attribute?"></a>为何会有 Filters Attribute?</h2><p><code>Filter</code> 本身只是 Mvc 的组件之一，其可以以任何级别注册到 <code>ServiceCollection</code> 当中，然而在使用 <code>Filter</code> 时通常只有两种情况:</p>
<ul>
<li>以全局方式在 <code>MvcOptions.Filters.Add</code> 对 <code>Filter</code> 进行注册，这种方式类似于一个集成了 Mvc 上下文的中间件</li>
<li>以 <code>Attribute</code> 方式对某些 <code>Controller</code> 或 <code>Action</code> 进行标记，以实现选择性地控制，ASP.NET Core 内置的 <code>AuthorizeAttribute</code> 就是采用的这种方式。</li>
</ul>
<p>ASP.NET Core 提供了 <code>IFilterMetaData</code> 接口来标识 <code>Filter</code>，任何类型都可以实现该接口以告知系统该类型可提供 <code>Filter</code>，而当 <code>Attribute</code> 实现了该接口并应用到指定 <code>Controller</code> 或 <code>Action</code> 时，系统会执行该 <code>Attribute</code> 的逻辑并假定该类型会返回 <code>IFilter</code> 接口。</p>
<h3 id="ServiceFilter-TypeFilters-和-IFilterFactory"><a href="#ServiceFilter-TypeFilters-和-IFilterFactory" class="headerlink" title="ServiceFilter, TypeFilters 和 IFilterFactory"></a>ServiceFilter, TypeFilters 和 IFilterFactory</h3><p>有时，<code>Filter</code> 需要依赖外部组件，当以 <code>Attribute</code> 的形式应用 <code>Filter</code> 时，由于 <code>Attribute</code> 的限制，无法进行构造注册，所以 ASP.NET Core 提供了以下几种方式来解决这个问题:</p>
<ul>
<li><code>ServiceFilterAttribute</code>: 该类型接收一个 <code>Type</code> 类型作为构造输入，该 <code>Type</code> 代表 <code>Filter</code> 的类型，并且需要在 <code>Startup</code> 的 <code>ConfigureServices</code> 中注册，否则将抛出异常。</li>
<li><code>TypeFilterAttribute</code>: 与 <code>ServiceFilterAttribute</code> 类似，但 <code>Filter</code> 无需在 <code>Startup</code> 的 <code>ConfigureServices</code> 中注册，并可以部分传入构造函数的参数，这使得在创建 <code>Filter</code> 时对依赖的定义变得更加灵活。</li>
<li><code>IFilterFactory</code>: 该接口本身实现了 <code>IFilterMetaData</code>，并定义了一个 <code>IFilterMetadata CreateInstance(IServiceProvider serviceProvider)</code> 方法，用以创建相应 <code>Filter</code> 类型的实现，该方法提供了一个 <code>IServiceProvider</code> 的传入参数，意即可在创建 <code>Filter</code> 的实例之前解析它的依赖。这个接口通常由一个自定义 <code>Attribute</code> 类型实现，该类型与之关联的 <code>Filter</code> 类型组对定义，是对该 <code>Filter</code> 以 <code>Attribute</code> 的形式进行发布。</li>
</ul>
<h2 id="Middleware-还是-Filters"><a href="#Middleware-还是-Filters" class="headerlink" title="Middleware 还是 Filters?"></a>Middleware 还是 Filters?</h2><p>Filter 是 Mvc 的一部分而中间件不是，中间件在请求抵达 Mvc 之前对请求进行处理，在这里还访问不到任何有关 Mvc 的内容，所以如果不依赖 Mvc 的组件，例如 <code>Routes</code>, <code>Actions</code>, <code>Controllers</code> 等，优先使用 <code>Middleware</code>，反之使用 <code>Filters</code>。另外 ResourceFilter 的工作方式非常类似于 Middleware，但两者区别在于对 Mvc 组件的访问，以下为微软的官方解释:</p>
<blockquote>
<p>Resource filters work like middleware in that they surround the execution of everything that comes later in the pipeline. But filters differ from middleware in that they’re part of MVC, which means that they have access to MVC context and constructs.</p>
</blockquote>
<h2 id="为何要使用-HttpClientFactory"><a href="#为何要使用-HttpClientFactory" class="headerlink" title="为何要使用 HttpClientFactory?"></a>为何要使用 HttpClientFactory?</h2><p>TBD…</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/asp-net-core/" rel="tag"># asp.net core</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Web/ASP-NET-Core/aspnetcore-viewcomponent/" rel="next" title="ASP.NET Core 应用 - 视图组件">
                <i class="fa fa-chevron-left"></i> ASP.NET Core 应用 - 视图组件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/deployment/docker-setup/" rel="prev" title="Docker 初探 (1) - 搭建 Docker 环境">
                Docker 初探 (1) - 搭建 Docker 环境 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Frost He</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#DI-中的-AddScope-何时使用"><span class="nav-text">DI 中的 AddScope 何时使用?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Authorization"><span class="nav-text">Authorization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基于角色的授权机制"><span class="nav-text">基于角色的授权机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于-Claim-的授权机制"><span class="nav-text">基于 Claim 的授权机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#您真的了解中间件吗"><span class="nav-text">您真的了解中间件吗?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#隐式激活中间件还是基于工厂的方式激活中间件"><span class="nav-text">隐式激活中间件还是基于工厂的方式激活中间件?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为何会有-Filters-Attribute"><span class="nav-text">为何会有 Filters Attribute?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceFilter-TypeFilters-和-IFilterFactory"><span class="nav-text">ServiceFilter, TypeFilters 和 IFilterFactory</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Middleware-还是-Filters"><span class="nav-text">Middleware 还是 Filters?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为何要使用-HttpClientFactory"><span class="nav-text">为何要使用 HttpClientFactory?</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frost He</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        




  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=65458438";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === '') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
